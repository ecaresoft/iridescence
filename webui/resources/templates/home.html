{% extends "base.html" %}
{% block content %}
  <div class="row">
    <div class="span12">
    <script src="/js/vendor/raphael-min.js" type="text/javascript"></script>
    <script type="text/javascript">
    var tx = 20, ty = 20;
    // Creates canvas 320 Ã— 200 at 10, 50
    var paper = Raphael(10, 50, 640, 480);

    var toolbar = paper.rect(tx, ty, 40, 452);
    var basicShape = paper.rect(tx + 5, ty + 5, 30, 20);
    basicShape.attr({"fill-opacity": 0, "stroke-width": 2, cursor: "move"});
    var connectShape = paper.path("M25 55L55 80");
    connectShape.attr({"stroke-width": 2, cursor: "move"});

    var dragger = function() {
      this.ox = this.type == "rect" ? this.attr("x") : this.attr("cx");
      this.oy = this.type == "rect" ? this.attr("y") : this.attr("cy");
      this.animate({"fill-opacity": .2}, 500);
    }

    var move = function(dx, dy) {
      var att = this.type == "rect" ? {x: this.ox + dx, y: this.oy + dy} : {cx: this.ox + dx, cy: this.oy + dy};
      this.attr(att);
      // TODO
      paper.safari();
    }

    var up = function() {
      this.animate({"fill-opacity": 0}, 500);
    }

    Workspace = function() {};

    Workspace.prototype = {
      lenght: 0,
      first: null,
      last: null
    };

    Workspace.prototype.append = function(shape) {
      if(this.first === null) {
        shape.prev = shape;
        shape.next = shape;
        this.first = shape;
        this.last = shape;
      } else {
        shape.prev = this.last;
        shape.next = this.first;
        this.first.prev = shape;
        this.last.next = shape;
        this.last = shape;
      }
      this.lenght++;
    };

    Workspace.prototype.insertAfter = function(shape, newShape) {
      newShape.prev = shape;
      newShape.next = shape.next;
      shape.next.prev = newShape;
      shape.next = newShape;
      if (newShape.prev == this.last) { this.last = newShape; }
      this.lenght++;
    };

    Workspace.prototype.remove = function(shape) {
      if(this.lenght > 1) {
         shape.prev.next = shape.next;
         shape.next.prev = shape.prev;
         if(shape == this.first) { this.first = shape.next; }
         if(shape == this.last) { this.last = shape.prev; }
      } else {
         this.first = null;
         this.last = null;
      }
      shape.prev = null;
      shape.next = null;
      this.lenght--;
    }

    var addToDiagram = function (shape) {
      var color = Raphael.getColor(); // Get next color in spectrum
      newShape = shape.clone();
      newShape.attr({fill: color, stroke: color, 
          "fill-opacity": 0, "stroke-width": 2});
      newShape.attr("width", 50);
      newShape.attr("height", 30);
      newShape.attr("x", 50 + Math.floor(Math.random()*160));
      newShape.attr("y", 70 + Math.floor(Math.random()*160));
      newShape.drag(move, dragger, up);
      w.append(newShape);
    }

    var toolUp = function() {
      this.attr("x", tx + 5);
      this.attr("y", ty + 5);
      addToDiagram(this);
    }

    basicShape.drag(move, dragger, toolUp);

    var w = new Workspace();

    </script>
    </div>
  </div>
{% endblock %}
